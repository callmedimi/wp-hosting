services:
  # ==========================================
  # [STANDARD] TRAEFIK GATEWAY (Rules Traffic + SSL)
  # ==========================================
  traefik:
    image: traefik:v2.10
    container_name: shared_gateway
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Global Redirect to HTTPS
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      # SSL Resolver (Let's Encrypt - HTTP Challenge)
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      # - "--certificatesresolvers.myresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory" # Uncomment for testing
      - "--certificatesresolvers.myresolver.acme.email=admin@yourdomain.com"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ./letsencrypt:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - wp_shared_net
    restart: unless-stopped

  # ==========================================
  # [NEW] WEB FILE MANAGER (FileBrowser)
  # ==========================================
  # Manage all site files from your browser. No FTP needed.
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: shared_filebrowser
    user: "0:0" # Run as root to access all site folders
    volumes:
      - ../sites:/srv # Mount all sites
      - filebrowser_db:/database # Store users/settings
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.files.rule=Host(`files.localhost`)"
      - "traefik.http.routers.files.entrypoints=websecure"
      - "traefik.http.routers.files.tls.certresolver=myresolver"
      - "traefik.http.services.files.loadbalancer.server.port=80"
    networks:
      - wp_shared_net
    restart: unless-stopped

  # ==========================================
  # [NEW] EMAIL CATCHER (Mailpit)
  # ==========================================
  # Captures emails sent by WordPress for debugging
  mailpit:
    image: axllent/mailpit
    container_name: shared_mailpit
    environment:
      MP_MAX_MESSAGES: 5000
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mail.rule=Host(`mail.localhost`)"
      - "traefik.http.routers.mail.entrypoints=websecure"
      - "traefik.http.routers.mail.tls.certresolver=myresolver"
      - "traefik.http.services.mail.loadbalancer.server.port=8025"
    networks:
      - wp_shared_net
    restart: unless-stopped

  # ==========================================
  # [STANDARD] DATABASE ADMIN (Local)
  # ==========================================
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: shared_pma
    ports:
      - "8082:80"
    restart: always
    environment:
      PMA_ARBITRARY: 1
      UPLOAD_LIMIT: 128M
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pma.rule=Host(`pma.localhost`)"
      - "traefik.http.routers.pma.entrypoints=websecure"
      - "traefik.http.routers.pma.tls.certresolver=myresolver"
      - "traefik.http.services.pma.loadbalancer.server.port=80"
    networks:
      - wp_shared_net

  # ==========================================
  # [STANDARD] REPLICATION (Syncthing)
  # ==========================================
  syncthing:
    image: syncthing/syncthing
    container_name: shared_replication
    environment:
      - PUID=0
      - PGID=0
    volumes:
      - ../sites:/var/syncthing/sites
      - syncthing_config:/var/syncthing/config
    ports:
      - 22000:22000/tcp
      - 22000:22000/udp
      - 8384:8384
    networks:
      - wp_shared_net
    restart: unless-stopped

  # ==========================================
  # [MONITORING AGENT] NETDATA
  # ==========================================
  netdata:
    image: netdata/netdata
    container_name: shared_netdata
    hostname: node_hostname
    ports:
      - 19999:19999
    restart: unless-stopped
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      - netdata_config:/etc/netdata
      - netdata_lib:/var/lib/netdata
      - netdata_cache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
    networks:
      - wp_shared_net

  # ==========================================
  # [MANAGEMENT AGENT] PORTAINER AGENT
  # ==========================================
  portainer_agent:
    image: portainer/agent:latest
    container_name: shared_portainer_agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
    ports:
      - "9001:9001"
    networks:
      - wp_shared_net
    restart: always

  # ==========================================
  # [STANDARD] SHARED TOOLS
  # ==========================================
  shared_deps_provider:
    image: node:lts-alpine
    container_name: shared_deps
    volumes:
      - shared_node_modules:/shared/node_modules
    working_dir: /shared
    command: >
      sh -c " echo 'Setting up shared dependencies...' && npm config set registry https://registry.npmmirror.com && cd /shared && npm install tailwindcss lucide google-fonts-downloader && echo 'âœ… Dependencies installed in /shared/node_modules/' && tail -f /dev/null"
    networks:
      - wp_shared_net

networks:
  wp_shared_net:
    name: wp_shared_net
    driver: bridge

volumes:
  shared_node_modules:
    name: shared_node_modules
  netdata_config:
  netdata_lib:
  netdata_cache:
  syncthing_config:
  filebrowser_db:
