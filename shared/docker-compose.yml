services:
  # ==========================================
  # [STANDARD] TRAEFIK GATEWAY (Rules Traffic + SSL)
  # ==========================================
  traefik:
    image: traefik:latest
    container_name: shared_gateway
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # [NEW] Global WAF Middleware
      - "--entrypoints.web.http.middlewares=coraza-waf@file,geoblock-waf@file"
      - "--entrypoints.websecure.http.middlewares=coraza-waf@file,geoblock-waf@file"
      # Global redirect to HTTPS, but Traefik handles ACME challenges first
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.email=admin@${DOMAIN_NAME:-yourdomain.com}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      # [NEW] Coraza WAF Plugin Configuration
      - "--experimental.plugins.coraza.modulename=github.com/corazawaf/coraza-traefik-plugin"
      - "--experimental.plugins.coraza.version=v1.0.3"
      # [NEW] GeoBlock Plugin
      - "--experimental.plugins.geoblock.modulename=github.com/nscuro/traefik-plugin-geoblock"
      - "--experimental.plugins.geoblock.version=v0.7.0"
      # [NEW] Dynamic Config Provider (for WAF/GeoIP Rules)
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ./letsencrypt:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik-dynamic:/etc/traefik/dynamic:ro # [NEW] Mount Dynamic Configs
    environment:
      - DOCKER_API_VERSION=1.44
      - TRAEFIK_PROVIDERS_DOCKER_VERSION=1.44
      - WAR_MODE=true
    networks:
      - wp_shared_net
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 256M
    restart: unless-stopped

  # ==========================================
  # [NEW] BUNKERWEB WAF (Security Layer)
  # ==========================================
  waf:
    image: bunkerity/bunkerweb:latest
    container_name: shared_waf
    ports:
      - "80:8080"
      - "443:8443"
    environment:
      - MULTISITE=yes
      - USE_AUTO_CERT=no
      - USE_MODSECURITY=yes
      - USE_ANTIBOT=yes
      - USE_LIMIT_REQ=yes
      - LIMIT_REQ_RATE=10r/s
      - LIMIT_REQ_BURST=20
      - REMOVE_HEADERS=Server X-Powered-By
      - USE_REVERSE_PROXY=yes
      - REVERSE_PROXY_URL=/
      - REVERSE_PROXY_HOST=http://traefik:80
      - USE_GZIP=yes
      - USE_BROTLI=yes
      - ALLOWED_METHODS=GET|POST|HEAD|OPTIONS
      - BLOCK_USER_AGENTS=badbot|scanner|sqlmap
      - USE_REAL_IP=yes
      - REAL_IP_FROM=172.16.0.0/12
    networks:
      - wp_shared_net
    deploy:
      resources:
        limits:
          cpus: '0.75'
          memory: 512M
    restart: unless-stopped

  # ==========================================
  # [NEW] PHPMYADMIN (Database GUI)
  # ==========================================
  pma:
    image: phpmyadmin/phpmyadmin
    container_name: shared_pma
    environment:
      PMA_ARBITRARY: 1
    ports:
      - "8082:80"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pma.rule=Host(`pma.localhost`) || Host(`pma.${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.pma.entrypoints=websecure"
      - "traefik.http.routers.pma.tls=true"
    networks:
      - wp_shared_net
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped

  # ==========================================
  # [NEW] POSTE.IO (All-in-one Mail Server)
  # ==========================================
  poste:
    image: analogic/poste.io:latest
    container_name: shared_mail
    restart: unless-stopped
    environment:
      - TZ=Asia/Tehran
      - HTTPS=OFF
    ports:
      - "25:25"
      - "110:110"
      - "143:143"
      - "587:587"
      - "993:993"
      - "995:995"
      - "4190:4190"
    volumes:
      - ./mail_data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mail.rule=Host(`mail.localhost`) || Host(`mail.${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.mail.entrypoints=websecure"
      - "traefik.http.routers.mail.tls=true"
      - "traefik.http.services.mail.loadbalancer.server.port=80"
    networks:
      - wp_shared_net

  # ==========================================
  # [NEW] SHARED DEPENDENCIES PROVIDER
  # ==========================================
  shared_deps_provider:
    image: node:lts-alpine
    container_name: shared_deps
    volumes:
      - ./node_modules:/shared/node_modules
    working_dir: /shared
    command: sh -c "echo 'Shared tools ready' && tail -f /dev/null"
    network_mode: host
    restart: unless-stopped

  # ==========================================
  # [NEW] PORTAINER AGENT
  # ==========================================
  portainer_agent:
    image: portainer/agent:latest
    container_name: shared_portainer_agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
    ports:
      - "9001:9001"
    networks:
      - wp_shared_net
    restart: always

  # ==========================================
  # [STABILIZED] REPLICATION (Syncthing)
  # ==========================================
  replication:
    image: syncthing/syncthing
    container_name: shared_replication
    environment:
      - PUID=0
      - PGID=0
    volumes:
      - /opt/wp-hosting/sites:/var/syncthing
    ports:
      - "8384:8384"
      - "22000:22000/tcp"
      - "22000:22000/udp"
      - "21027:21027/udp"
    networks:
      - wp_shared_net
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
    restart: unless-stopped

networks:
  wp_shared_net:
    external: true
