services:
  # ==========================================
  # [STANDARD] TRAEFIK GATEWAY (Rules Traffic + SSL)
  # ==========================================
  traefik:
    image: traefik:latest
    container_name: shared_gateway
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Global redirect to HTTPS, but Traefik handles ACME challenges first
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.email=admin@${DOMAIN_NAME:-yourdomain.com}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ./letsencrypt:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - DOCKER_API_VERSION=1.44
      - TRAEFIK_PROVIDERS_DOCKER_VERSION=1.44
      - WAR_MODE=true
    networks:
      - wp_shared_net
    restart: unless-stopped

  # ==========================================
  # [NEW] WEB FILE MANAGER (FileBrowser)
  # ==========================================
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: shared_filebrowser
    user: "0:0"
    volumes:
      - /opt/wp-hosting/sites:/srv
      - ./filebrowser.db:/database.db
    ports:
      - "8083:80"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.files.rule=Host(`files.localhost`) || Host(`files.${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.files.entrypoints=websecure"
      - "traefik.http.routers.files.tls=true"
    networks:
      - wp_shared_net
    healthcheck:
      test: [ "CMD", "/healthcheck.sh" ]
      interval: 2m
    restart: unless-stopped

  # ==========================================
  # [NEW] PHPMYADMIN (Database GUI)
  # ==========================================
  pma:
    image: phpmyadmin/phpmyadmin
    container_name: shared_pma
    environment:
      PMA_ARBITRARY: 1
    ports:
      - "8082:80"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pma.rule=Host(`pma.localhost`) || Host(`pma.${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.pma.entrypoints=websecure"
      - "traefik.http.routers.pma.tls=true"
    networks:
      - wp_shared_net
    restart: unless-stopped

  # ==========================================
  # [NEW] POSTE.IO (All-in-one Mail Server)
  # ==========================================
  poste:
    image: analogic/poste.io:latest
    container_name: shared_mail
    restart: unless-stopped
    environment:
      - TZ=Asia/Tehran
      - HTTPS=OFF
    ports:
      - "25:25"
      - "110:110"
      - "143:143"
      - "587:587"
      - "993:993"
      - "995:995"
      - "4190:4190"
    volumes:
      - ./mail_data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mail.rule=Host(`mail.localhost`) || Host(`mail.${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.mail.entrypoints=websecure"
      - "traefik.http.routers.mail.tls=true"
      - "traefik.http.services.mail.loadbalancer.server.port=80"
    networks:
      - wp_shared_net

  # ==========================================
  # [NEW] SHARED DEPENDENCIES PROVIDER
  # ==========================================
  shared_deps_provider:
    image: node:lts-alpine
    container_name: shared_deps
    volumes:
      - ./node_modules:/shared/node_modules
    working_dir: /shared
    command: sh -c "echo 'Shared tools ready' && tail -f /dev/null"
    network_mode: host
    restart: unless-stopped

  # ==========================================
  # [NEW] PORTAINER AGENT
  # ==========================================
  portainer_agent:
    image: portainer/agent:latest
    container_name: shared_portainer_agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
    ports:
      - "9001:9001"
    restart: always

  # ==========================================
  # [NEW] REPLICATION (Syncthing)
  # ==========================================
  replication:
    image: syncthing/syncthing
    container_name: shared_replication
    environment:
      - PUID=0
      - PGID=0
    volumes:
      - /opt/wp-hosting/sites:/var/syncthing
    ports:
      - "8384:8384"
      - "22000:22000/tcp"
      - "22000:22000/udp"
      - "21027:21027/udp"
    restart: unless-stopped
  # ==========================================
  # [NEW] NETDATA (Lightweight Host + Docker Monitoring)
  # ==========================================
  netdata:
    image: netdata/netdata
    container_name: shared_netdata
    pid: host
    network_mode: host
    restart: unless-stopped
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - netdataconfig:/etc/netdata
      - netdatalib:/var/lib/netdata
      - netdatacache:/var/cache/netdata
      - /:/host/root:ro,rslave
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/log:/host/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

networks:
  wp_shared_net:
    external: true

volumes:
  netdataconfig:
  netdatalib:
  netdatacache:
